<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Buzzer App (Supabase Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .leaderboard-item { animation: slideIn 0.3s ease-out forwards; }
        #qrcode-container { background: white; padding: 1rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transition: transform 0.3s ease-in-out; }
        .config-needed { border: 2px dashed #f59e0b; padding: 1rem; border-radius: 0.5rem; background-color: #1f2937; }
        .form-input { appearance: none; background-color: #1f2937; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem 1rem; color: white; width: 100%; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: #fbbf24; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen overflow-hidden">

    <div id="app-container" class="w-full h-screen">
        <!-- Configuration Missing View -->
        <div id="config-view" class="hidden text-center max-w-lg p-4 mx-auto mt-10">
             <div class="config-needed">
                <h1 class="text-3xl font-bold text-amber-400 mb-4">Configuration Needed</h1>
                <p class="text-gray-300">Please open this HTML file, find the `SUPABASE_URL` and `SUPABASE_ANON_KEY` variables, and replace the placeholder values with your project's credentials.</p>
                <a href="https://supabase.com/dashboard" target="_blank" class="mt-4 inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Go to Supabase Dashboard</a>
            </div>
        </div>
        
        <!-- Admin Setup View -->
        <div id="admin-setup-view" class="hidden w-full h-full flex flex-col items-center justify-center p-4">
            <div class="w-full max-w-md text-center">
                <h1 class="text-5xl font-bold mb-8 text-yellow-400">Create a New Game</h1>
                <div class="space-y-6">
                    <div>
                        <label for="game-name-input" class="block text-left text-lg font-medium text-gray-300 mb-2">Game Name</label>
                        <input type="text" id="game-name-input" placeholder="e.g., Friday Trivia Night" class="form-input">
                    </div>
                    <div>
                        <label for="questions-input" class="block text-left text-lg font-medium text-gray-300 mb-2">Number of Questions</label>
                        <input type="number" id="questions-input" placeholder="e.g., 10" class="form-input">
                    </div>
                </div>
                <button id="create-game-button" class="mt-10 w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition-transform transform hover:scale-105 disabled:opacity-50">
                    Create Game Session
                </button>
            </div>
        </div>

        <!-- Host View -->
        <div id="host-view" class="hidden w-full h-screen p-4 md:p-8 flex flex-col md:flex-row items-center justify-center md:justify-around text-center overflow-hidden">
            <div class="w-full md:w-1/2 flex flex-col items-center justify-center mb-8 md:mb-0 md:pr-8">
                <h1 id="game-title-display" class="text-4xl md:text-5xl font-bold mb-2 text-yellow-400">Game Title</h1>
                <h2 id="question-counter-display" class="text-2xl md:text-3xl font-medium text-gray-300 mb-6">Question 1 / 10</h2>
                <div id="qrcode-container" class="mb-8">
                    <div id="qrcode"></div>
                </div>
                <button id="reset-button" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                    Next Question
                </button>
            </div>
            <div class="w-full md:w-1/2 h-full flex flex-col items-center justify-center">
                <div class="w-full max-w-2xl h-full flex flex-col">
                    <h2 class="text-3xl md:text-4xl font-bold mb-6 flex-shrink-0">Leaderboard</h2>
                    <div class="overflow-y-auto flex-grow">
                        <ol id="leaderboard" class="space-y-3 text-left"></ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client View -->
        <div id="client-view" class="hidden w-full h-full flex flex-col items-center justify-center p-4">
            <div id="waiting-screen" class="hidden text-center">
                <h1 class="text-4xl font-bold mb-6">Waiting for Host</h1>
                <p class="text-lg text-gray-400">Please scan the QR code on the main screen to join the game.</p>
            </div>
            <div id="register-screen" class="hidden w-full max-w-sm text-center">
                <h1 class="text-4xl font-bold mb-6">Enter Your Name</h1>
                <input type="text" id="name-input" placeholder="Your Name" class="w-full px-4 py-3 bg-gray-800 border-2 border-gray-600 rounded-lg text-white text-lg focus:outline-none focus:border-yellow-400 transition mb-4" autocomplete="name">
                <button id="register-button" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition-transform transform hover:scale-105">Join Game</button>
            </div>
            <div id="buzzer-screen" class="hidden w-full h-full flex flex-col items-center justify-center text-center">
                 <div id="user-info" class="absolute top-4 text-lg text-gray-400"></div>
                 <p id="buzzer-status" class="text-2xl font-medium mb-8">&nbsp;</p>
                 <button id="buzzer-button" class="w-64 h-64 md:w-80 md:h-80 bg-red-600 rounded-full shadow-2xl flex items-center justify-center text-white font-black text-6xl transition-transform transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5); border: 10px solid #a01010;">BUZZ!</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SUPABASE_URL = 'https://vpvssqytxxzmldazphcp.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwdnNzcXl0eHh6bWxkYXpwaGNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1ODQ4NzQsImV4cCI6MjA3MzE2MDg3NH0.wzUjd3Zyi1iz49b33FrdCVZln9MWEI0WnTBw919_0M8';
            
            const App = {
                state: {
                    supabase: null,
                    session: null,
                    currentQuestion: 1,
                    qrCodeInstance: null,
                },
                
                elements: {
                    configView: document.getElementById('config-view'),
                    adminSetupView: document.getElementById('admin-setup-view'),
                    hostView: document.getElementById('host-view'),
                    clientView: document.getElementById('client-view'),
                },

                init() {
                    try {
                        const options = {
                            global: { headers: { 'x-application-name': 'buzzer-app' } },
                            realtime: { params: { eventsPerSecond: 10 } },
                        };
                        this.state.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, options);
                        if (!this.state.supabase) throw new Error("Supabase client could not be initialized.");
                        
                        this.router();
                    } catch (error) {
                        this.showError(error.message);
                    }
                },

                showError(message) {
                    console.error("Initialization failed:", message);
                    Object.values(this.elements).forEach(el => el.classList.add('hidden'));
                    this.elements.configView.classList.remove('hidden');
                    const errorParagraph = this.elements.configView.querySelector('p');
                    errorParagraph.innerHTML = `<strong>Error:</strong> Could not start the app. <br><br> <span class="text-sm text-gray-400">Details: ${message}</span>`;
                },

                router() {
                    const params = new URLSearchParams(window.location.search);
                    const view = params.get('view');
                    const sessionId = params.get('session');
                    
                    if (view === 'admin') this.Admin.init();
                    else if (view === 'host' && sessionId) this.Host.init(sessionId);
                    else if (sessionId) this.Client.init(sessionId);
                    else this.Client.init(null);
                },

                Admin: {
                    init() {
                        App.elements.adminSetupView.classList.remove('hidden');
                        document.getElementById('create-game-button').onclick = App.Admin.createGame;
                    },
                    async createGame() {
                        const gameName = document.getElementById('game-name-input').value.trim();
                        const totalQuestions = parseInt(document.getElementById('questions-input').value, 10);
                        if (!gameName || !totalQuestions || totalQuestions <= 0) {
                            alert("Please enter a valid game name and number of questions."); return;
                        }
                        
                        const createButton = document.getElementById('create-game-button');
                        createButton.disabled = true;
                        createButton.textContent = "Creating...";

                        const { data, error } = await App.state.supabase
                            .from('sessions')
                            .insert({ game_name: gameName, total_questions: totalQuestions })
                            .select()
                            .single();
                        
                        if (error) {
                            alert(`Error creating game session:\n\n${error.message}\n\nPlease ensure you have run the latest SQL script in your Supabase project.`);
                            createButton.disabled = false;
                            createButton.textContent = "Create Game Session";
                            return;
                        }
                        window.location.search = `?view=host&session=${data.id}`;
                    }
                },

                Host: {
                    state: { realtimeChannel: null },
                    async init(sessionId) {
                        App.elements.hostView.classList.remove('hidden');
                        const { data, error } = await App.state.supabase.from('sessions').select().eq('id', sessionId).single();
                        if (error || !data) { App.showError("Game session not found."); return; }
                        
                        App.state.session = data;
                        App.state.currentQuestion = data.current_question;
                        this.render();
                        this.listenForBuzzes();

                        document.getElementById('reset-button').onclick = this.nextQuestion.bind(this);
                    },
                    render() {
                        const { session, currentQuestion } = App.state;
                        document.getElementById('game-title-display').textContent = session.game_name;
                        document.getElementById('question-counter-display').textContent = `Question ${currentQuestion} / ${session.total_questions}`;
                        
                        if (!App.state.qrCodeInstance) this.generateQRCode();
                        
                        this.fetchLeaderboard();
                    },
                    generateQRCode() {
                        const clientUrl = `${window.location.origin}${window.location.pathname}?session=${App.state.session.id}`;
                        App.state.qrCodeInstance = new QRCode(document.getElementById('qrcode'), {
                            text: clientUrl, width: 256, height: 256,
                            colorDark : "#000000", colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                    },
                    async nextQuestion() {
                        if (App.state.currentQuestion >= App.state.session.total_questions) {
                            alert("This is the final question!"); return;
                        }
                        App.state.currentQuestion++;
                        const { error } = await App.state.supabase
                            .from('sessions')
                            .update({ current_question: App.state.currentQuestion })
                            .eq('id', App.state.session.id);
                        if (error) { console.error("Failed to update question", error); App.state.currentQuestion--; return; }
                        
                        this.render();
                    },
                    async fetchLeaderboard() {
                        const { session, currentQuestion } = App.state;
                        const { data, error } = await App.state.supabase
                            .from('buzzes')
                            .select('name')
                            .eq('session_id', session.id)
                            .eq('question_number', currentQuestion)
                            .order('created_at', { ascending: true })
                            .limit(10);
                        
                        if (error) { console.error('Error fetching leaderboard:', error); return; }
                        
                        const leaderboard = document.getElementById('leaderboard');
                        leaderboard.innerHTML = '';
                        data.forEach((buzz, index) => {
                            const li = document.createElement('li');
                            li.className = 'leaderboard-item text-xl md:text-2xl p-3 bg-gray-800 rounded-lg flex items-center';
                            let medal = (index === 0) ? 'ðŸ¥‡' : (index === 1) ? 'ðŸ¥ˆ' : (index === 2) ? 'ðŸ¥‰' : `<strong>${index + 1}</strong>`;
                            li.innerHTML = `<span class="text-3xl w-12 text-center">${medal}</span> <span>${buzz.name}</span>`;
                            leaderboard.appendChild(li);
                        });
                    },
                    listenForBuzzes() {
                        if (this.state.realtimeChannel) App.state.supabase.removeChannel(this.state.realtimeChannel);
                        this.state.realtimeChannel = App.state.supabase.channel(`session-${App.state.session.id}`)
                            .on('postgres_changes', 
                                { event: 'INSERT', schema: 'public', table: 'buzzes', filter: `session_id=eq.${App.state.session.id}` }, 
                                (payload) => {
                                    if (payload.new.question_number === App.state.currentQuestion) {
                                        this.fetchLeaderboard();
                                    }
                                }
                            )
                            .subscribe();
                    }
                },

                Client: {
                    state: { realtimeChannel: null },
                    init(sessionId) {
                        const waitingScreen = document.getElementById('waiting-screen');
                        if (!sessionId) { 
                            waitingScreen.classList.remove('hidden'); 
                            return; 
                        }
                        
                        document.getElementById('register-screen').classList.remove('hidden');

                        const nameInput = document.getElementById('name-input');
                        const storedName = localStorage.getItem('buzzerUserName');
                        if (storedName) {
                            nameInput.value = storedName;
                        }
                        
                        document.getElementById('register-button').onclick = () => App.Client.handleRegistration(sessionId);
                    },
                    handleRegistration(sessionId) {
                        const name = document.getElementById('name-input').value.trim();
                        if (name) {
                            localStorage.setItem('buzzerUserName', name);
                            this.showBuzzerScreen(name, sessionId);
                        }
                    },
                    showBuzzerScreen(name, sessionId) {
                        document.getElementById('register-screen').classList.add('hidden');
                        document.getElementById('buzzer-screen').classList.remove('hidden');
                        document.getElementById('user-info').textContent = `Playing as: ${name}`;
                        this.checkIfAlreadyBuzzed(sessionId);
                        document.getElementById('buzzer-button').onclick = this.buzzIn.bind(this, sessionId);
                        this.listenForQuestionChanges(sessionId);
                    },
                    getOrSetUserId() {
                        let id = localStorage.getItem('buzzerUserId');
                        if (!id) { id = crypto.randomUUID(); localStorage.setItem('buzzerUserId', id); }
                        return id;
                    },
                    listenForQuestionChanges(sessionId) {
                        if (this.state.realtimeChannel) App.state.supabase.removeChannel(this.state.realtimeChannel);
                        this.state.realtimeChannel = App.state.supabase.channel(`client-session-${sessionId}`)
                            .on('postgres_changes',
                                { event: 'UPDATE', schema: 'public', table: 'sessions', filter: `id=eq.${sessionId}` },
                                (payload) => {
                                    const buzzerButton = document.getElementById('buzzer-button');
                                    const buzzerStatus = document.getElementById('buzzer-status');
                                    buzzerButton.disabled = false;
                                    buzzerStatus.innerHTML = '&nbsp;';
                                    this.checkIfAlreadyBuzzed(sessionId);
                                }
                            )
                            .subscribe();
                    },
                    async checkIfAlreadyBuzzed(sessionId) {
                        const { data: sessionData } = await App.state.supabase.from('sessions').select('current_question').eq('id', sessionId).single();
                        if (!sessionData) return;
                        
                        const { data: buzzData } = await App.state.supabase
                            .from('buzzes')
                            .select('id')
                            .eq('user_id', this.getOrSetUserId())
                            .eq('session_id', sessionId)
                            .eq('question_number', sessionData.current_question)
                            .single();
                        
                        if (buzzData) {
                            document.getElementById('buzzer-button').disabled = true;
                            document.getElementById('buzzer-status').textContent = "You've buzzed for this question!";
                        }
                    },
                    async buzzIn(sessionId) {
                        const buzzerButton = document.getElementById('buzzer-button');
                        const buzzerStatus = document.getElementById('buzzer-status');
                        buzzerButton.disabled = true;
                        buzzerStatus.textContent = "Buzzing in...";

                        try {
                            const { data: sessionData, error: sessionError } = await App.state.supabase.from('sessions').select('current_question').eq('id', sessionId).single();
                            if (sessionError || !sessionData) throw new Error("Could not find active game session.");

                            const userId = this.getOrSetUserId();
                            const currentUserName = localStorage.getItem('buzzerUserName');

                            const { error: insertError } = await App.state.supabase
                                .from('buzzes')
                                .insert({ name: currentUserName, user_id: userId, session_id: sessionId, question_number: sessionData.current_question });

                            if (insertError) {
                                if (insertError.code === '23505') buzzerStatus.textContent = "You've already buzzed!";
                                else throw insertError;
                            } else {
                                buzzerStatus.textContent = "You're on the board!";
                            }
                        } catch (e) {
                            console.error('Error buzzing in:', e);
                            buzzerStatus.textContent = 'Error! Try again.';
                            buzzerButton.disabled = false;
                        }
                    }
                }
            };

            // This robust listener waits for the document to be ready, then polls for the libraries.
            const libraryCheck = setInterval(() => {
                if (window.supabase && window.QRCode) {
                    clearInterval(libraryCheck); // Stop polling
                    App.init(); // Start the app
                }
            }, 100); // Check every 100 milliseconds
        });
    </script>
</body>
</html>

