<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Buzzer App (Supabase Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- REMOVED: The old Supabase script tag is no longer needed. -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .leaderboard-item { animation: slideIn 0.3s ease-out forwards; }
        #qrcode-container {
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .config-needed {
            border: 2px dashed #f59e0b;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen overflow-hidden">

    <!-- Configuration Missing View -->
    <div id="config-view" class="hidden text-center max-w-lg p-4">
         <div class="config-needed">
            <h1 class="text-3xl font-bold text-amber-400 mb-4">Configuration Needed</h1>
            <p class="text-gray-300">This app requires Supabase credentials to function. Please open this HTML file in a text editor, find the `SUPABASE_URL` and `SUPABASE_ANON_KEY` variables in the script section, and replace the placeholder values with your project's credentials.</p>
            <a href="https://supabase.com/dashboard" target="_blank" class="mt-4 inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Go to Supabase Dashboard</a>
        </div>
    </div>

    <!-- Host View: Displays QR Code and Leaderboard -->
    <div id="host-view" class="hidden w-full h-full p-4 md:p-8 flex flex-col items-center justify-center text-center">
        <h1 class="text-4xl md:text-6xl font-bold mb-4 text-yellow-400">Scan to Buzz!</h1>
        <p class="text-lg md:text-xl text-gray-300 mb-6">Use your phone camera to scan the code below.</p>
        <div id="qrcode-container" class="mb-8">
            <div id="qrcode"></div>
        </div>
        
        <div class="w-full max-w-2xl">
            <h2 class="text-3xl md:text-4xl font-bold mb-6">Leaderboard</h2>
            <ol id="leaderboard" class="space-y-3 text-left"></ol>
        </div>

        <button id="reset-button" class="mt-8 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
            Reset Buzzers
        </button>
    </div>

    <!-- Client View: Registration and Buzzer Button -->
    <div id="client-view" class="hidden w-full h-full flex flex-col items-center justify-center p-4">
        <!-- Registration Screen -->
        <div id="register-screen" class="w-full max-w-sm text-center">
            <h1 class="text-4xl font-bold mb-6">Enter Your Name</h1>
            <input type="text" id="name-input" placeholder="Your Name" class="w-full px-4 py-3 bg-gray-800 border-2 border-gray-600 rounded-lg text-white text-lg focus:outline-none focus:border-yellow-400 transition mb-4" autocomplete="name">
            <button id="register-button" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition-transform transform hover:scale-105">
                Join Game
            </button>
        </div>

        <!-- Buzzer Screen -->
        <div id="buzzer-screen" class="hidden w-full h-full flex flex-col items-center justify-center text-center">
             <div id="user-info" class="absolute top-4 text-lg text-gray-400"></div>
             <p id="buzzer-status" class="text-2xl font-medium mb-8">&nbsp;</p>
             <button id="buzzer-button" class="w-64 h-64 md:w-80 md:h-80 bg-red-600 rounded-full shadow-2xl flex items-center justify-center text-white font-black text-6xl transition-transform transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5); border: 10px solid #a01010;">
                BUZZ!
            </button>
        </div>
    </div>

    <!-- Supabase and App Logic -->
    <script type="module">
        // DEFINITIVE FIX 1: Import the Supabase client directly inside the module.
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://kwbwnuwemdlefpefhjdt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3YndudXdlbWRsZWZwZWZoamR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NTUzMDcsImV4cCI6MjA3MzEzMTMwN30.bW1VKtKAQLoV33Fwdpimf24P4v6HDewT9Bvo8_JxUVc';

        let supabase;

        // --- Main Application Entry Point ---
        // The script now waits for the import to finish automatically.
        // We can run the initialization code directly.
        
        try {
            // DEFINITIVE FIX 2: Use the imported `createClient` function directly.
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            if (!supabase) {
                throw new Error("Supabase client could not be initialized. Check your URL and Key.");
            }
            
            // Determine view and start the correct part of the app
            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view');
    
            if (view === 'host') {
                document.getElementById('host-view').classList.remove('hidden');
                startHostView();
            } else {
                document.getElementById('client-view').classList.remove('hidden');
                startClientView();
            }

        } catch (error) {
            console.error("Initialization failed:", error);
            const configView = document.getElementById('config-view');
            configView.classList.remove('hidden');
            const errorParagraph = document.querySelector('#config-view p');
            errorParagraph.innerHTML = `<strong>Error:</strong> Could not connect to Supabase. Please double-check your SUPABASE_URL and SUPABASE_ANON_KEY. <br><br> <span class="text-sm text-gray-400">Details: ${error.message}</span>`;
        }


        // --- Host View Logic ---
        function startHostView() {
            const leaderboard = document.getElementById('leaderboard');
            const resetButton = document.getElementById('reset-button');
            
            // Generate QR Code
            const qrCodeElement = document.getElementById('qrcode');
            const clientUrl = window.location.href.split('?')[0];
            new QRCode(qrCodeElement, {
                text: clientUrl,
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            // Listen for buzzes
            const listenForBuzzes = () => {
                supabase.channel('buzzes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'buzzes' }, fetchLeaderboard)
                    .subscribe();
                fetchLeaderboard(); // Fetch initial state
            };
            
            const fetchLeaderboard = async () => {
                const { data, error } = await supabase
                    .from('buzzes')
                    .select('name')
                    .order('created_at', { ascending: true })
                    .limit(10);
                    
                if (error) {
                    console.error('Error fetching leaderboard:', error);
                    return;
                }
                
                leaderboard.innerHTML = ''; // Clear current list
                data.forEach((buzz, index) => {
                    const li = document.createElement('li');
                    li.className = 'leaderboard-item text-xl md:text-2xl p-3 bg-gray-800 rounded-lg flex items-center';
                    
                    let medal = '';
                    if (index === 0) medal = 'ðŸ¥‡';
                    else if (index === 1) medal = 'ðŸ¥ˆ';
                    else if (index === 2) medal = 'ðŸ¥‰';

                    li.innerHTML = `<span class="text-3xl w-12 text-center">${medal || `<strong>${index + 1}</strong>`}</span> <span>${buzz.name}</span>`;
                    leaderboard.appendChild(li);
                });
            };

            // Reset functionality
            resetButton.onclick = async () => {
                if (confirm('Are you sure you want to reset all buzzes?')) {
                    const { error } = await supabase.from('buzzes').delete().gt('id', 0); // Deletes all rows
                    if (error) {
                        console.error('Error resetting buzzes:', error);
                    } else {
                        leaderboard.innerHTML = '';
                    }
                }
            };
            
            listenForBuzzes();
        }

        // --- Client View Logic ---
        function startClientView() {
            const registerScreen = document.getElementById('register-screen');
            const buzzerScreen = document.getElementById('buzzer-screen');
            const nameInput = document.getElementById('name-input');
            const registerButton = document.getElementById('register-button');
            const buzzerButton = document.getElementById('buzzer-button');
            const buzzerStatus = document.getElementById('buzzer-status');
            const userInfo = document.getElementById('user-info');

            let userName = localStorage.getItem('buzzerUserName');
            const userId = getOrSetUserId();

            if (userName) {
                showBuzzerScreen(userName);
            }

            registerButton.onclick = () => {
                const name = nameInput.value.trim();
                if (name) {
                    localStorage.setItem('buzzerUserName', name);
                    showBuzzerScreen(name);
                }
            };

            function showBuzzerScreen(name) {
                userName = name;
                registerScreen.classList.add('hidden');
                buzzerScreen.classList.remove('hidden');
                userInfo.textContent = `Playing as: ${name}`;
                checkIfAlreadyBuzzed();
            }

            async function checkIfAlreadyBuzzed() {
                const { data, error } = await supabase
                    .from('buzzes')
                    .select('id')
                    .eq('user_id', userId)
                    .single();

                if (data) {
                    buzzerButton.disabled = true;
                    buzzerStatus.textContent = "You've buzzed in!";
                }
            }
            
            buzzerButton.onclick = async () => {
                buzzerButton.disabled = true;
                buzzerStatus.textContent = "Buzzing in...";
                
                try {
                    const { error } = await supabase
                        .from('buzzes')
                        .insert({ name: userName, user_id: userId });

                    if (error) {
                        // This likely means the user has already buzzed (due to the unique constraint)
                        if (error.code === '23505') { // Unique violation
                             buzzerStatus.textContent = "You've already buzzed!";
                        } else {
                            throw error;
                        }
                    } else {
                        buzzerStatus.textContent = "You're on the board!";
                    }
                } catch (e) {
                    console.error('Error buzzing in:', e);
                    buzzerStatus.textContent = 'Error! Try again.';
                    buzzerButton.disabled = false; // Allow retry on other errors
                }
            };

            function getOrSetUserId() {
                let id = localStorage.getItem('buzzerUserId');
                if (!id) {
                    id = crypto.randomUUID();
                    localStorage.setItem('buzzerUserId', id);
                }
                return id;
            }
        }

    </script>
</body>
</html>

