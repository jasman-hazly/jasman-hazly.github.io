<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Buzzer App (Supabase Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .leaderboard-item { animation: slideIn 0.3s ease-out forwards; }
        #qrcode-container {
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out;
        }
        .config-needed {
            border: 2px dashed #f59e0b;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen overflow-hidden">

    <!-- Configuration Missing View -->
    <div id="config-view" class="hidden text-center max-w-lg p-4">
         <div class="config-needed">
            <h1 class="text-3xl font-bold text-amber-400 mb-4">Configuration Needed</h1>
            <p class="text-gray-300">This app requires Supabase credentials to function. Please open this HTML file in a text editor, find the `SUPABASE_URL` and `SUPABASE_ANON_KEY` variables in the script section, and replace the placeholder values with your project's credentials.</p>
            <a href="https://supabase.com/dashboard" target="_blank" class="mt-4 inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Go to Supabase Dashboard</a>
        </div>
    </div>

    <!-- Host View: Displays QR Code and Leaderboard -->
    <div id="host-view" class="hidden w-full h-screen p-4 md:p-8 flex flex-col md:flex-row items-center justify-center md:justify-around text-center overflow-hidden">
        
        <!-- Left Column: QR Code & Info -->
        <div class="w-full md:w-1/2 flex flex-col items-center justify-center mb-8 md:mb-0 md:pr-8">
            <h1 class="text-4xl md:text-6xl font-bold mb-4 text-yellow-400">Scan for this Round!</h1>
            <p class="text-lg md:text-xl text-gray-300 mb-6">A new QR code is generated for each question.</p>
            <div id="qrcode-container" class="mb-8">
                <div id="qrcode"></div>
            </div>
            <button id="reset-button" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                Reset for Next Question
            </button>
        </div>

        <!-- Right Column: Leaderboard -->
        <div class="w-full md:w-1/2 h-full flex flex-col items-center justify-center">
            <div class="w-full max-w-2xl h-full flex flex-col">
                <h2 class="text-3xl md:text-4xl font-bold mb-6 flex-shrink-0">Leaderboard</h2>
                <div class="overflow-y-auto flex-grow">
                    <ol id="leaderboard" class="space-y-3 text-left"></ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Client View: Registration and Buzzer Button -->
    <div id="client-view" class="hidden w-full h-full flex flex-col items-center justify-center p-4">
        <!-- Waiting Screen (No Round ID) -->
        <div id="waiting-screen" class="hidden text-center">
            <h1 class="text-4xl font-bold mb-6">Waiting for Host</h1>
            <p class="text-lg text-gray-400">Please scan the QR code on the main screen to join a round.</p>
        </div>

        <!-- Registration Screen -->
        <div id="register-screen" class="hidden w-full max-w-sm text-center">
            <h1 class="text-4xl font-bold mb-6">Enter Your Name</h1>
            <input type="text" id="name-input" placeholder="Your Name" class="w-full px-4 py-3 bg-gray-800 border-2 border-gray-600 rounded-lg text-white text-lg focus:outline-none focus:border-yellow-400 transition mb-4" autocomplete="name">
            <button id="register-button" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition-transform transform hover:scale-105">
                Join Round
            </button>
        </div>

        <!-- Buzzer Screen -->
        <div id="buzzer-screen" class="hidden w-full h-full flex flex-col items-center justify-center text-center">
             <div id="user-info" class="absolute top-4 text-lg text-gray-400"></div>
             <p id="buzzer-status" class="text-2xl font-medium mb-8">&nbsp;</p>
             <button id="buzzer-button" class="w-64 h-64 md:w-80 md:h-80 bg-red-600 rounded-full shadow-2xl flex items-center justify-center text-white font-black text-6xl transition-transform transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5); border: 10px solid #a01010;">
                BUZZ!
            </button>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            const SUPABASE_URL = 'https://kwbwnuwemdlefpefhjdt.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInRypecCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3YndudXdlbWRsZWZwZWZoamR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NTUzMDcsImV4cCI6MjA3MzEzMTMwN30.bW1VKtKAQLoV33Fwdpimf24P4v6HDewT9Bvo8_JxUVc';
            let supabase;

            function initializeApp() {
                try {
                    if (typeof window.supabase === 'undefined' || typeof QRCode === 'undefined') {
                       throw new Error("Required libraries (Supabase, QRCode) failed to load.");
                    }
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    if (!supabase) {
                        throw new Error("Supabase client could not be initialized.");
                    }
                    const urlParams = new URLSearchParams(window.location.search);
                    const view = urlParams.get('view');
                    if (view === 'host') {
                        document.getElementById('host-view').classList.remove('hidden');
                        startHostView();
                    } else {
                        document.getElementById('client-view').classList.remove('hidden');
                        startClientView();
                    }
                } catch (error) {
                    console.error("Initialization failed:", error);
                    const configView = document.getElementById('config-view');
                    document.getElementById('host-view').classList.add('hidden');
                    document.getElementById('client-view').classList.add('hidden');
                    configView.classList.remove('hidden');
                    const errorParagraph = document.querySelector('#config-view p');
                    errorParagraph.innerHTML = `<strong>Error:</strong> Could not start the app. <br><br> <span class="text-sm text-gray-400">Details: ${error.message}</span>`;
                }
            }

            function startHostView() {
                const leaderboard = document.getElementById('leaderboard');
                const resetButton = document.getElementById('reset-button');
                const qrCodeElement = document.getElementById('qrcode');
                const qrCodeContainer = document.getElementById('qrcode-container');
                let currentRoundId;
                let qrCodeInstance = null;

                function generateNewRound() {
                    currentRoundId = crypto.randomUUID();
                    const clientUrl = `${window.location.href.split('?')[0]}?round=${currentRoundId}`;
                    
                    qrCodeContainer.style.transform = 'scale(0)';
                    setTimeout(() => {
                        if (qrCodeInstance) {
                            qrCodeInstance.clear();
                            qrCodeInstance.makeCode(clientUrl);
                        } else {
                            qrCodeInstance = new QRCode(qrCodeElement, {
                                text: clientUrl, width: 256, height: 256,
                                colorDark : "#000000", colorLight : "#ffffff",
                                correctLevel : QRCode.CorrectLevel.H
                            });
                        }
                        qrCodeContainer.style.transform = 'scale(1)';
                    }, 300);
                    
                    fetchLeaderboard();
                }

                const listenForBuzzes = () => {
                    supabase.channel('buzzes')
                        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'buzzes', filter: `round_id=eq.${currentRoundId}` }, fetchLeaderboard)
                        .subscribe();
                };
                
                const fetchLeaderboard = async () => {
                    if (!currentRoundId) return;
                    const { data, error } = await supabase
                        .from('buzzes')
                        .select('name')
                        .eq('round_id', currentRoundId)
                        .order('created_at', { ascending: true })
                        .limit(10);
                        
                    if (error) {
                        console.error('Error fetching leaderboard:', error); return;
                    }
                    
                    leaderboard.innerHTML = '';
                    data.forEach((buzz, index) => {
                        const li = document.createElement('li');
                        li.className = 'leaderboard-item text-xl md:text-2xl p-3 bg-gray-800 rounded-lg flex items-center';
                        let medal = (index === 0) ? 'ðŸ¥‡' : (index === 1) ? 'ðŸ¥ˆ' : (index === 2) ? 'ðŸ¥‰' : `<strong>${index + 1}</strong>`;
                        li.innerHTML = `<span class="text-3xl w-12 text-center">${medal}</span> <span>${buzz.name}</span>`;
                        leaderboard.appendChild(li);
                    });
                };

                resetButton.onclick = async () => {
                    leaderboard.innerHTML = '';
                    // We don't need to delete from DB if each round is unique. 
                    // But it's good practice to clean up old rounds if desired. This is optional.
                    generateNewRound();
                };
                
                generateNewRound(); // Start the first round on load
                listenForBuzzes();
            }

            function startClientView() {
                const urlParams = new URLSearchParams(window.location.search);
                const roundId = urlParams.get('round');

                const waitingScreen = document.getElementById('waiting-screen');
                const registerScreen = document.getElementById('register-screen');
                const buzzerScreen = document.getElementById('buzzer-screen');
                const nameInput = document.getElementById('name-input');
                const registerButton = document.getElementById('register-button');
                const buzzerButton = document.getElementById('buzzer-button');
                const buzzerStatus = document.getElementById('buzzer-status');
                const userInfo = document.getElementById('user-info');
                
                if (!roundId) {
                    waitingScreen.classList.remove('hidden');
                    return;
                }

                let userName = localStorage.getItem('buzzerUserName');
                const userId = getOrSetUserId();

                if (userName) {
                    showBuzzerScreen(userName);
                } else {
                    registerScreen.classList.remove('hidden');
                }

                registerButton.onclick = () => {
                    const name = nameInput.value.trim();
                    if (name) {
                        localStorage.setItem('buzzerUserName', name);
                        showBuzzerScreen(name);
                    }
                };

                function showBuzzerScreen(name) {
                    userName = name;
                    registerScreen.classList.add('hidden');
                    buzzerScreen.classList.remove('hidden');
                    userInfo.textContent = `Playing as: ${name}`;
                    checkIfAlreadyBuzzed();
                }

                async function checkIfAlreadyBuzzed() {
                    const { data, error } = await supabase
                        .from('buzzes')
                        .select('id')
                        .eq('user_id', userId)
                        .eq('round_id', roundId)
                        .single();

                    if (data) {
                        buzzerButton.disabled = true;
                        buzzerStatus.textContent = "You've buzzed in for this round!";
                    }
                }
                
                buzzerButton.onclick = async () => {
                    buzzerButton.disabled = true;
                    buzzerStatus.textContent = "Buzzing in...";
                    
                    try {
                        const { error } = await supabase
                            .from('buzzes')
                            .insert({ name: userName, user_id: userId, round_id: roundId });

                        if (error) {
                            if (error.code === '23505') { // Unique violation
                                 buzzerStatus.textContent = "You've already buzzed!";
                            } else { throw error; }
                        } else {
                            buzzerStatus.textContent = "You're on the board!";
                        }
                    } catch (e) {
                        console.error('Error buzzing in:', e);
                        buzzerStatus.textContent = 'Error! Try again.';
                        buzzerButton.disabled = false;
                    }
                };

                function getOrSetUserId() {
                    let id = localStorage.getItem('buzzerUserId');
                    if (!id) {
                        id = crypto.randomUUID();
                        localStorage.setItem('buzzerUserId', id);
                    }
                    return id;
                }
            }
            
            initializeApp();
        });
    </script>
</body>
</html>


